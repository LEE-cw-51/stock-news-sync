name: Stock Data Sync & AWS Lambda Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë° "ê°•ë ¥í•œ" ê²½ëŸ‰í™” ì‘ì—…
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          rm -rf backend/lib
          mkdir -p backend/lib
          
          # curl_cffi ê°™ì€ ë°”ì´ë„ˆë¦¬ ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ìœ„í•´ --no-binary ëŒ€ì‹  
          # Lambda í™˜ê²½(manylinux)ì— ë§ëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
          pip install \
            --platform manylinux2014_x86_64 \
            --target backend/lib \
            --implementation cp \
            --python-version 3.11 \
            --only-binary=:all: \
            --upgrade \
            -r backend/requirements.txt

          # [ì¶”ê°€] curl_cffiì˜ ë©”íƒ€ë°ì´í„° ëˆ„ë½ ë°©ì§€ë¥¼ ìœ„í•œ ì²˜ë¦¬
          # ì¼ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” .dist-info í´ë”ê°€ ì‚­ì œë˜ë©´ ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, 
          # ì•„ê¹Œì™€ ë‹¬ë¦¬ ì‚­ì œ ëª©ë¡ì—ì„œ dist-infoë¥¼ ì œì™¸í•˜ê±°ë‚˜ ì‹ ì¤‘íˆ ì‚­ì œí•©ë‹ˆë‹¤.
          cd backend/lib
          find . -type d -name "__pycache__" -exec rm -rf {} +
          # find . -type d -name "*.dist-info" -exec rm -rf {} + # <-- ì´ ì¤„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”.
          find . -type d -name "tests" -exec rm -rf {} +
          rm -rf boto3 botocore s3transfer

      # 2. AWS ìê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 3. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (í´ë” êµ¬ì¡° ìœ ì§€, í‚¤ íŒŒì¼ ì œì™¸)
      - name: Create Zip Package
        run: |
          # 1) ë¼ì´ë¸ŒëŸ¬ë¦¬ ì••ì¶• (Lambda ê·œì¹™ì— ë§ê²Œ ìµœìƒìœ„ì— ì••ì¶•)
          cd backend/lib
          zip -r ../../deploy_package.zip .
          cd ../..

          # 2) ì†ŒìŠ¤ ì½”ë“œëŠ” 'backend' í´ë” êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©° ì¶”ê°€ ì••ì¶•
          #    (lib, pycache, serviceAccount.json ì œì™¸)
          zip -g -r deploy_package.zip backend/ \
            -x "backend/lib/*" "backend/__pycache__/*" "backend/serviceAccount.json"

      # 4. S3 ì—…ë¡œë“œ ë° Lambda ì—…ë°ì´íŠ¸ (ì •ì„ì ì¸ Wait State ì ìš©)
      - name: Deploy to AWS Lambda & Sync Config
        env:
          S3_BUCKET: "my-stock-sync-deploy-bucket"
        run: |
          # 1) S3ë¡œ íŒŒì¼ ë³µì‚¬
          aws s3 cp deploy_package.zip s3://$S3_BUCKET/deploy_package.zip
          
          # 2) ì½”ë“œ ì—…ë°ì´íŠ¸
          aws lambda update-function-code \
            --function-name stock-news-sync \
            --s3-bucket $S3_BUCKET \
            --s3-key deploy_package.zip > /dev/null

          # ğŸŒŸ [ì •ì„] ì½”ë“œ ì—…ë°ì´íŠ¸ê°€ ì™„ì „íˆ ë°˜ì˜ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          # ResourceConflictExceptionì„ ë°©ì§€í•˜ëŠ” ê°€ì¥ ì „ë¬¸ì ì¸ ë°©ë²•ì…ë‹ˆë‹¤.
          echo "Waiting for Lambda function code update to complete..."
          aws lambda wait function-updated --function-name stock-news-sync
          
          # 3) í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (Firebase í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œë§Œ ì „ë‹¬, íŒŒì¼ í¬í•¨ X)
          aws lambda update-function-configuration \
            --function-name stock-news-sync \
            --environment "Variables={GROQ_API_KEY=${{ secrets.GROQ_API_KEY }},TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }},FIREBASE_SERVICE_ACCOUNT=${{ secrets.FIREBASE_SERVICE_ACCOUNT }}}" > /dev/null