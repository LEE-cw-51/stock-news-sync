name: Stock Data Sync & AWS Lambda Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 1. 라이브러리 설치 및 "강력한" 경량화 작업
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          rm -rf backend/lib
          mkdir -p backend/lib
          
          # curl_cffi 같은 바이너리 의존성 라이브러리를 위해 --no-binary 대신 
          # Lambda 환경(manylinux)에 맞는 바이너리를 명시적으로 설치합니다.
          pip install \
            --platform manylinux2014_x86_64 \
            --target backend/lib \
            --implementation cp \
            --python-version 3.11 \
            --only-binary=:all: \
            --upgrade \
            -r backend/requirements.txt

          # [추가] curl_cffi의 메타데이터 누락 방지를 위한 처리
          # 일부 라이브러리는 .dist-info 폴더가 삭제되면 작동하지 않으므로, 
          # 아까와 달리 삭제 목록에서 dist-info를 제외하거나 신중히 삭제합니다.
          cd backend/lib
          find . -type d -name "__pycache__" -exec rm -rf {} +
          # find . -type d -name "*.dist-info" -exec rm -rf {} + # <-- 이 줄을 주석 처리하거나 삭제하세요.
          find . -type d -name "tests" -exec rm -rf {} +
          rm -rf boto3 botocore s3transfer

      # 2. AWS 자격 증명 설정
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 3. 배포 패키지 생성 (폴더 구조 유지, 키 파일 제외)
      - name: Create Zip Package
        run: |
          # 1) 라이브러리 압축 (Lambda 규칙에 맞게 최상위에 압축)
          cd backend/lib
          zip -r ../../deploy_package.zip .
          cd ../..

          # 2) 소스 코드는 'backend' 폴더 구조를 그대로 유지하며 추가 압축
          #    (lib, pycache, serviceAccount.json 제외)
          zip -g -r deploy_package.zip backend/ \
            -x "backend/lib/*" "backend/__pycache__/*" "backend/serviceAccount.json"

      # 4. S3 업로드 및 Lambda 업데이트 (정석적인 Wait State 적용)
      - name: Deploy to AWS Lambda & Sync Config
        env:
          S3_BUCKET: "my-stock-sync-deploy-bucket"
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # 1) S3로 파일 복사
          aws s3 cp deploy_package.zip s3://$S3_BUCKET/deploy_package.zip

          # 2) 코드 업데이트
          aws lambda update-function-code \
            --function-name stock-news-sync \
            --s3-bucket $S3_BUCKET \
            --s3-key deploy_package.zip > /dev/null

          # 코드 업데이트가 완전히 반영될 때까지 대기
          echo "Waiting for Lambda function code update to complete..."
          aws lambda wait function-updated --function-name stock-news-sync

          # 3) 환경 변수 업데이트
          # JSON을 포함한 값은 인라인 shell 삽입 시 특수문자가 깨지므로
          # Python으로 JSON 파일을 생성한 뒤 --cli-input-json으로 안전하게 전달
          python3 - <<'PYEOF'
import json, os

config = {
    "FunctionName": "stock-news-sync",
    "Environment": {
        "Variables": {
            "GROQ_API_KEY": os.environ["GROQ_API_KEY"].strip(),
            "TAVILY_API_KEY": os.environ["TAVILY_API_KEY"].strip(),
            "FIREBASE_SERVICE_ACCOUNT": os.environ["FIREBASE_SERVICE_ACCOUNT"].strip(),
        }
    }
}
with open("lambda_env.json", "w") as f:
    json.dump(config, f)
print("lambda_env.json generated")
PYEOF

          aws lambda update-function-configuration \
            --cli-input-json file://lambda_env.json > /dev/null

          # 환경변수가 담긴 임시 파일 즉시 삭제
          rm -f lambda_env.json