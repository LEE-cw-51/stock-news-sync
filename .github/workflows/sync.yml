name: Stock Data Sync & AWS Lambda Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë° "ê°•ë ¥í•œ" ê²½ëŸ‰í™” ìž‘ì—…
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          rm -rf backend/lib
          mkdir -p backend/lib
          
          pip install -r backend/requirements.txt -t backend/lib --platform manylinux2014_x86_64 --only-binary=:all: --implementation cp --python-version 3.11 --upgrade
          
          cd backend/lib
          find . -type d -name "__pycache__" -exec rm -rf {} +
          find . -type d -name "*.dist-info" -exec rm -rf {} +
          find . -type d -name "tests" -exec rm -rf {} +
          find . -type d -name "bin" -exec rm -rf {} +
          rm -rf boto3 botocore s3transfer

      # 2. AWS ìžê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # # 3. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (ðŸŒŸ ìµœìƒìœ„ ê²½ë¡œ ì••ì¶• ë°©ì‹ìœ¼ë¡œ ê°œì„ )
      - name: Create Zip Package with Firebase Key
        env:
          FIREBASE_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # 1) JSON íŒŒì¼ ìƒì„±
          echo "$FIREBASE_JSON" > backend/serviceAccount.json
          
          # 2) ë¼ì´ë¸ŒëŸ¬ë¦¬ ì••ì¶• (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìµœìƒìœ„ë¡œ)
          cd backend/lib
          zip -r ../../deploy_package.zip .
          
          # 3) ì†ŒìŠ¤ ì½”ë“œ ì¶”ê°€ ì••ì¶• (ðŸŒŸ í•µì‹¬ ë³€ê²½ì : backend í´ë” ì•ˆì—ì„œ ì•Œë§¹ì´ë§Œ ì••ì¶•)
          cd .. # í˜„ìž¬ ìœ„ì¹˜ë¥¼ backend/lib ì—ì„œ backend/ ë¡œ ì´ë™
          zip -g ../deploy_package.zip *.py config/*.py services/*.py *.json
      # 4. S3 ì—…ë¡œë“œ ë° Lambda ì—…ë°ì´íŠ¸ (ì •ì„ì ì¸ Wait State ì ìš©)
      - name: Deploy to AWS Lambda & Sync Config
        env:
          S3_BUCKET: "my-stock-sync-deploy-bucket"
        run: |
          # 1) S3ë¡œ íŒŒì¼ ë³µì‚¬
          aws s3 cp deploy_package.zip s3://$S3_BUCKET/deploy_package.zip
          
          # 2) ì½”ë“œ ì—…ë°ì´íŠ¸
          aws lambda update-function-code \
            --function-name stock-news-sync \
            --s3-bucket $S3_BUCKET \
            --s3-key deploy_package.zip > /dev/null

          # ðŸŒŸ [ì •ì„] ì½”ë“œ ì—…ë°ì´íŠ¸ê°€ ì™„ì „ížˆ ë°˜ì˜ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          # ResourceConflictExceptionì„ ë°©ì§€í•˜ëŠ” ê°€ìž¥ ì „ë¬¸ì ì¸ ë°©ë²•ìž…ë‹ˆë‹¤.
          echo "Waiting for Lambda function code update to complete..."
          aws lambda wait function-updated --function-name stock-news-sync
          
          # 3) í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          aws lambda update-function-configuration \
            --function-name stock-news-sync \
            --environment "Variables={GROQ_API_KEY=${{ secrets.GROQ_API_KEY }},TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}}" > /dev/null