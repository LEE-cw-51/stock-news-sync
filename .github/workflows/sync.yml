name: Stock Data Sync & AWS Lambda Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë° "ê°•ë ¥í•œ" ê²½ëŸ‰í™” ìž‘ì—…
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ê¸°ì¡´ ë¼ì´ë¸ŒëŸ¬ë¦¬ í´ë” ì‚­ì œ í›„ ìž¬ìƒì„±
          rm -rf backend/lib
          mkdir -p backend/lib
          
          # Linux í™˜ê²½ì— ìµœì í™”ëœ ë°”ì´ë„ˆë¦¬ ì„¤ì¹˜ (Lambda í™˜ê²½ í˜¸í™˜ì„±)
          pip install -r backend/requirements.txt -t backend/lib --platform manylinux2014_x86_64 --only-binary=:all: --implementation cp --python-version 3.11 --upgrade
          
          # [ìš©ëŸ‰ ìµœì í™” í•µì‹¬] ë¶ˆí•„ìš”í•œ í´ë” ë° íŒŒì¼ ê°•ì œ ì‚­ì œ
          cd backend/lib
          find . -type d -name "__pycache__" -exec rm -rf {} +
          find . -type d -name "*.dist-info" -exec rm -rf {} +
          find . -type d -name "tests" -exec rm -rf {} +
          find . -type d -name "bin" -exec rm -rf {} +
          
          # AWS Lambdaì— ê¸°ë³¸ ë‚´ìž¥ëœ boto3 ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚­ì œ (ìš©ëŸ‰ ëŒ€í­ ì ˆê°)
          rm -rf boto3 botocore s3transfer

      # 2. AWS ìžê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 3. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (ðŸŒŸ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: JSON íŒŒì¼ ë™ì  ìƒì„±)
      - name: Create Zip Package with Firebase Key
        env:
          FIREBASE_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # GitHub Secretsì— ìžˆëŠ” ê¸´ JSON ë¬¸ìžì—´ì„ backend í´ë” ì•ˆì— ì‹¤ì œ íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
          echo "$FIREBASE_JSON" > backend/serviceAccount.json
          
          # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì••ì¶•
          cd backend/lib
          zip -r ../../deploy_package.zip .
          cd ../..
          
          # ê¸°ì¡´ íŒŒì´ì¬ ì½”ë“œë“¤ê³¼ ë°©ê¸ˆ ìƒì„±í•œ json íŒŒì¼ì„ í•¨ê»˜ ì••ì¶•
          zip -g deploy_package.zip backend/*.py backend/config/*.py backend/services/*.py backend/*.json

      # 4. S3 ì—…ë¡œë“œ ë° Lambda ì—…ë°ì´íŠ¸ (ðŸŒŸ ê¹”ë”í•´ì§„ í™˜ê²½ ë³€ìˆ˜ ì£¼ìž…)
      - name: Deploy to AWS Lambda & Sync Config
        env:
          S3_BUCKET: "my-stock-sync-deploy-bucket"
        run: |
          # 1) S3ë¡œ íŒŒì¼ ë³µì‚¬
          aws s3 cp deploy_package.zip s3://$S3_BUCKET/deploy_package.zip
          
          # 2) S3ì— ìžˆëŠ” íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ Lambda ì½”ë“œ ì—…ë°ì´íŠ¸ (ë¡œê·¸ ìˆ¨ê¹€ ì²˜ë¦¬)
          aws lambda update-function-code \
            --function-name stock-news-sync \
            --s3-bucket $S3_BUCKET \
            --s3-key deploy_package.zip > /dev/null
          
          # 3) í™˜ê²½ ë³€ìˆ˜ í†µí•© ì—…ë°ì´íŠ¸
          # ë³µìž¡í•œ JSONì€ íŒŒì¼ë¡œ ì••ì¶•í•´ ë³´ëƒˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ê¹”ë”í•˜ê²Œ ì¼ë°˜ API í‚¤ 2ê°œë§Œ ì£¼ìž…í•©ë‹ˆë‹¤.
          aws lambda update-function-configuration \
            --function-name stock-news-sync \
            --environment "Variables={GROQ_API_KEY=${{ secrets.GROQ_API_KEY }},TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}}" > /dev/null